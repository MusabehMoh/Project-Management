<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gantt Chart</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
            color: #333;
            line-height: 1.6;
            padding: 20px;
        }
        body.rtl {
            direction: rtl;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        .rtl .container {
            direction: rtl;
        }
        .controls {
            display: flex;
            justify-content: space-between;
            padding: 15px 20px;
            background: #ecf0f1;
            border-bottom: 1px solid #ddd;
        }
        .rtl .controls {
            direction: rtl;
        }
        .btn {
            padding: 8px 15px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s;
        }
        .btn:hover {
            background: #2980b9;
        }
        .gantt-container {
            padding: 20px;
            overflow-x: auto;
            width: 100%;
        }
        .gantt-chart {
            min-width: 100%;
            position: relative;
        }
        .gantt-grid {
            display: grid;
            border: 1px solid #ddd;
            border-radius: 4px;
            overflow: hidden;
            min-width: fit-content;
        }
        .grid-header {
            background: #f8f9fa;
            font-weight: bold;
            padding: 10px;
            text-align: center;
            border-bottom: 2px solid #ddd;
            position: sticky;
            left: 0;
            z-index: 10;
        }
        .grid-cell {
            padding: 8px;
            border-right: 1px solid #eee;
            border-bottom: 1px solid #eee;
            min-height: 40px;
        }
        .task-info {
            background: #f8f9fa;
            font-weight: 500;
            display: flex;
            align-items: center;
            padding: 0 10px;
            position: sticky;
            left: 0;
            z-index: 5;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .task-bar-container {
            position: relative;
            display: flex;
            align-items: center;
            height: 100%;
            min-width: 0;
        }
        .task-bar {
            height: 20px;
            border-radius: 4px;
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 5px;
            font-size: 12px;
            color: white;
            cursor: pointer;
            transition: opacity 0.2s;
            top: 50%;
            transform: translateY(-50%);
        }
        .rtl .task-bar {
            padding-right: 0;
            padding-left: 5px;
            justify-content: flex-start;
        }
        .task-bar:hover {
            opacity: 0.8;
        }
        .day-cell {
            text-align: center;
            padding: 5px;
            border-right: 1px solid #eee;
            background: #f8f9fa;
            min-width: 30px;
        }
        .month-cell {
            text-align: center;
            padding: 8px;
            border-right: 1px solid #ddd;
            background: #e9ecef;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 8;
        }
        .expand-toggle {
            margin-right: 8px;
            cursor: pointer;
            width: 20px;
            text-align: center;
        }
        .rtl .expand-toggle {
            margin-right: 0;
            margin-left: 8px;
        }
        .hidden {
            display: none;
        }
        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="controls">
            <div>
                <button class="btn" id="expand-all">Expand All</button>
                <button class="btn" id="collapse-all">Collapse All</button>
            </div>
        </div>
        
        <div class="gantt-container">
            <div class="loading hidden" id="loading">
                <!-- <div class="spinner"></div> -->
            </div>
            <div class="gantt-chart" id="gantt-chart">
                <!-- Grid will be generated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let timelineData = null;
        let expandedState = {};
        let flatTasks = [];
        let language = 'en'; // Default language
        
        // Initialize the Gantt chart
        document.addEventListener('DOMContentLoaded', function() {
            // Parse URL parameters
            const urlParams = new URLSearchParams(window.location.search);
            const timelineParam = urlParams.get('timeline');
            const langParam = urlParams.get('lang');
            
            // Set language
            if (langParam && (langParam === 'en' || langParam === 'ar')) {
                language = langParam;
                if (language === 'ar') {
                    document.body.classList.add('rtl');
                    document.querySelector('.container').classList.add('rtl');
                    document.querySelector('.controls').classList.add('rtl');
                }
            }
            
            if (timelineParam) {
                try {
                    timelineData = JSON.parse(decodeURIComponent(timelineParam));
                    processTimelineData();
                } catch (e) {
                    console.error('Error parsing timeline data: ' + e.message);
                    // Use default data if parsing fails
                    loadDefaultData();
                }
            } else {
                // Use the provided data if no URL parameter
                loadDefaultData();
            }
            
            // Expand/Collapse all functionality
            document.getElementById('expand-all').addEventListener('click', () => {
                Object.keys(expandedState).forEach(key => {
                    expandedState[key] = true;
                });
                renderGanttChart();
            });

            document.getElementById('collapse-all').addEventListener('click', () => {
                Object.keys(expandedState).forEach(key => {
                    expandedState[key] = false;
                });
                renderGanttChart();
            });
        });

        function loadDefaultData() {
            timelineData = { 
                "id": 1, 
                "treeId": "timeline-1", 
                "projectId": 1, 
                "name": language === 'ar' ? "بوابة العملاء المرحلة 1" : "Client Portal Phase 1", 
                "description": language === 'ar' ? "المرحلة الأولى من تطوير إعادة تصميم بوابة العملاء" : "First phase of client portal redesign", 
                "startDate": "2025-01-15", 
                "endDate": "2025-03-15", 
                "createdAt": "2025-01-01T10:00:00Z", 
                "updatedAt": "2025-01-10T15:30:00Z", 
                "sprints": [ 
                    { 
                        "id": 1, 
                        "treeId": "sprint-1", 
                        "timelineId": 1, 
                        "name": language === 'ar' ? "مرحلة تصميم واجهة المستخدم" : "UI Design Phase", 
                        "description": language === 'ar' ? "تصميم واجهة المستخدم وتجربة المستخدم" : "UI and UX design", 
                        "startDate": "2025-01-15", 
                        "endDate": "2025-02-15", 
                        "duration": 31, 
                        "statusId": 2, 
                        "departmentId": 3, 
                        "createdAt": "2025-01-01T10:00:00Z", 
                        "updatedAt": "2025-01-10T15:30:00Z", 
                        "requirements": [ 
                            { 
                                "id": 1, 
                                "treeId": "requirement-1", 
                                "sprintId": 1, 
                                "name": language === 'ar' ? "تصميم الإطارات السلكية" : "Wireframe Design", 
                                "description": language === 'ar' ? "إنشاء إطارات سلكية شاملة لجميع الصفحات الرئيسية" : "Create comprehensive wireframes for all main pages", 
                                "startDate": "2025-01-15", 
                                "endDate": "2025-01-30", 
                                "duration": 15, 
                                "statusId": 2, 
                                "priorityId": 3, 
                                "progress": 65, 
                                "departmentId": 3, 
                                "resources": [ "1" ], 
                                "createdAt": "2025-01-01T10:00:00Z", 
                                "updatedAt": "2025-01-20T11:15:00Z", 
                                "tasks": [ 
                                    { 
                                        "id": 1, 
                                        "treeId": "task-1", 
                                        "requirementId": 1, 
                                        "name": language === 'ar' ? "إطار صفحة تسجيل الدخول" : "Login Page Wireframe", 
                                        "description": language === 'ar' ? "تصميم الإطار الخاص بصفحة المصادقة للمستخدم" : "Design authentication page layout", 
                                        "assigneeId": 1, 
                                        "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                        "statusId": 4, 
                                        "priorityId": 3, 
                                        "departmentId": 3, 
                                        "estimatedHours": 8, 
                                        "actualHours": 6, 
                                        "startDate": "2025-01-15", 
                                        "endDate": "2025-01-18", 
                                        "duration": 3, 
                                        "dependencies": [], 
                                        "createdAt": "2025-01-01T10:00:00Z", 
                                        "updatedAt": "2025-01-18T14:30:00Z", 
                                        "subtasks": [ 
                                            { 
                                                "id": 1, 
                                                "treeId": "subtask-1", 
                                                "taskId": 1, 
                                                "name": language === 'ar' ? "تصميم نموذج تسجيل الدخول" : "Login Form Design", 
                                                "description": language === 'ar' ? "تصميم تخطيط نموذج تسجيل الدخول وتحديد المواقع" : "Design login form layout and positioning", 
                                                "assigneeId": 1, 
                                                "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                                "statusId": 4, 
                                                "priorityId": 3, 
                                                "departmentId": 3, 
                                                "estimatedHours": 4, 
                                                "actualHours": 3, 
                                                "createdAt": "2025-01-01T10:00:00Z", 
                                                "updatedAt": "2025-01-18T14:30:00Z", 
                                                "dependentTasks": [], 
                                                "members": [], 
                                                "depTasks": [] 
                                            }, 
                                            { 
                                                "id": 2, 
                                                "treeId": "subtask-2", 
                                                "taskId": 1, 
                                                "name": language === 'ar' ? "تصميم استرجاع كلمة المرور" : "Password Recovery Design", 
                                                "description": language === 'ar' ? "تصميم الإطار الخاص بنموذج نسيت كلمة المرور" : "Design password recovery form", 
                                                "assigneeId": 1, 
                                                "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                                "statusId": 4, 
                                                "priorityId": 2, 
                                                "departmentId": 3, 
                                                "estimatedHours": 4, 
                                                "actualHours": 3, 
                                                "createdAt": "2025-01-01T10:00:00Z", 
                                                "updatedAt": "2025-01-18T14:30:00Z", 
                                                "dependentTasks": [], 
                                                "members": [], 
                                                "depTasks": [] 
                                            } 
                                        ], 
                                        "dependentTasks": [], 
                                        "members": [], 
                                        "depTasks": [] 
                                    }, 
                                    { 
                                        "id": 2, 
                                        "treeId": "task-2", 
                                        "requirementId": 1, 
                                        "name": language === 'ar' ? "إطار لوحة التحكم" : "Dashboard Wireframe", 
                                        "description": language === 'ar' ? "تصميم تخطيط ومكونات لوحة التحكم الرئيسية" : "Design dashboard layout and components", 
                                        "assigneeId": 1, 
                                        "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                        "statusId": 2, 
                                        "priorityId": 2, 
                                        "departmentId": 3, 
                                        "estimatedHours": 12, 
                                        "actualHours": 8, 
                                        "startDate": "2025-01-19", 
                                        "endDate": "2025-01-25", 
                                        "duration": 6, 
                                        "dependencies": [ 1 ], 
                                        "createdAt": "2025-01-01T10:00:00Z", 
                                        "updatedAt": "2025-01-20T11:15:00Z", 
                                        "subtasks": [ 
                                            { 
                                                "id": 3, 
                                                "treeId": "subtask-3", 
                                                "taskId": 2, 
                                                "name": language === 'ar' ? "تصميم تخطيط الويدجيت" : "Widget Layout Design", 
                                                "description": language === 'ar' ? "تصميم تخطيطات الويدجيت في لوحة التحكم ونظام الشبكة" : "Design widget layouts and grid system", 
                                                "assigneeId": 1, 
                                                "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                                "statusId": 2, 
                                                "priorityId": 2, 
                                                "departmentId": 3, 
                                                "estimatedHours": 6, 
                                                "actualHours": 4, 
                                                "createdAt": "2025-01-01T10:00:00Z", 
                                                "updatedAt": "2025-01-20T11:15:00Z", 
                                                "dependentTasks": [], 
                                                "members": [], 
                                                "depTasks": [] 
                                            }, 
                                            { 
                                                "id": 4, 
                                                "treeId": "subtask-4", 
                                                "taskId": 2, 
                                                "name": language === 'ar' ? "قائمة التنقل" : "Navigation Menu", 
                                                "description": language === 'ar' ? "تصميم قائمة تنقل واستجابة للعرض" : "Design navigation menu and responsiveness", 
                                                "assigneeId": 1, 
                                                "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                                "statusId": 2, 
                                                "priorityId": 3, 
                                                "departmentId": 3, 
                                                "estimatedHours": 6, 
                                                "actualHours": 4, 
                                                "createdAt": "2025-01-01T10:00:00Z", 
                                                "updatedAt": "2025-01-22T16:45:00Z", 
                                                "dependentTasks": [], 
                                                "members": [], 
                                                "depTasks": [] 
                                            } 
                                        ], 
                                        "dependentTasks": [], 
                                        "members": [], 
                                        "depTasks": [] 
                                    }, 
                                    { 
                                        "id": 3, 
                                        "treeId": "task-3", 
                                        "requirementId": 1, 
                                        "name": language === 'ar' ? "إطار إعدادات الملف الشخصي" : "Profile Settings Wireframe", 
                                        "description": language === 'ar' ? "تصميم إطار صفحة إعدادات وملف المستخدم" : "Design user profile and settings page", 
                                        "assigneeId": 1, 
                                        "assigneeName": language === 'ar' ? "سارة علي الحسن" : "Sarah Ali", 
                                        "statusId": 1, 
                                        "priorityId": 2, 
                                        "departmentId": 3, 
                                        "estimatedHours": 10, 
                                        "actualHours": 0, 
                                        "startDate": "2025-01-26", 
                                        "endDate": "2025-01-30", 
                                        "duration": 4, 
                                        "dependencies": [], 
                                        "createdAt": "2025-01-01T10:00:00Z", 
                                        "updatedAt": "2025-01-15T09:00:00Z", 
                                        "subtasks": [], 
                                        "dependentTasks": [], 
                                        "members": [], 
                                        "depTasks": [] 
                                    } 
                                ], 
                                "dependentTasks": [], 
                                "members": [], 
                                "depTasks": [] 
                            } 
                        ] 
                    } 
                ] 
            };
            processTimelineData();
        }

        // Process timeline data
        function processTimelineData() {
            document.getElementById('loading').classList.remove('hidden');
            
            // Flatten the nested structure into a flat array of tasks
            flatTasks = [];
            
            // Add the timeline itself as a top-level item
            if (timelineData) {
                const timelineTask = {
                    id: timelineData.treeId || `timeline-${timelineData.id}`,
                    name: timelineData.name,
                    description: timelineData.description,
                    startDate: timelineData.startDate,
                    endDate: timelineData.endDate,
                    level: 0,
                    type: 'timeline',
                    progress: calculateTimelineProgress(timelineData)
                };
                flatTasks.push(timelineTask);
                expandedState[timelineTask.id] = true;
                
                // Process sprints
                if (timelineData.sprints && timelineData.sprints.length) {
                    timelineData.sprints.forEach(sprint => {
                        const sprintTask = {
                            id: sprint.treeId || `sprint-${sprint.id}`,
                            name: sprint.name,
                            description: sprint.description,
                            startDate: sprint.startDate,
                            endDate: sprint.endDate,
                            level: 1,
                            parent: timelineTask.id,
                            type: 'sprint',
                            progress: calculateSprintProgress(sprint)
                        };
                        flatTasks.push(sprintTask);
                        expandedState[sprintTask.id] = true;
                        
                        // Process requirements
                        if (sprint.requirements && sprint.requirements.length) {
                            sprint.requirements.forEach(req => {
                                const reqTask = {
                                    id: req.treeId || `requirement-${req.id}`,
                                    name: req.name,
                                    description: req.description,
                                    startDate: req.startDate,
                                    endDate: req.endDate,
                                    level: 2,
                                    parent: sprintTask.id,
                                    type: 'requirement',
                                    progress: req.progress || 0
                                };
                                flatTasks.push(reqTask);
                                expandedState[reqTask.id] = true;
                                
                                // Process tasks
                                if (req.tasks && req.tasks.length) {
                                    req.tasks.forEach(task => {
                                        const taskItem = {
                                            id: task.treeId || `task-${task.id}`,
                                            name: task.name,
                                            description: task.description,
                                            startDate: task.startDate,
                                            endDate: task.endDate,
                                            level: 3,
                                            parent: reqTask.id,
                                            type: 'task',
                                            progress: calculateTaskProgress(task),
                                            assigneeName: task.assigneeName,
                                            statusId: task.statusId,
                                            estimatedHours: task.estimatedHours,
                                            actualHours: task.actualHours
                                        };
                                        flatTasks.push(taskItem);
                                        expandedState[taskItem.id] = true;
                                        
                                        // Process subtasks
                                        if (task.subtasks && task.subtasks.length) {
                                            task.subtasks.forEach(subtask => {
                                                const subtaskItem = {
                                                    id: subtask.treeId || `subtask-${subtask.id}`,
                                                    name: subtask.name,
                                                    description: subtask.description,
                                                    startDate: subtask.startDate || task.startDate,
                                                    endDate: subtask.endDate || task.endDate,
                                                    level: 4,
                                                    parent: taskItem.id,
                                                    type: 'subtask',
                                                    progress: calculateSubtaskProgress(subtask),
                                                    assigneeName: subtask.assigneeName,
                                                    statusId: subtask.statusId,
                                                    estimatedHours: subtask.estimatedHours,
                                                    actualHours: subtask.actualHours
                                                };
                                                flatTasks.push(subtaskItem);
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                renderGanttChart();
            }
        }

        // Helper functions to calculate progress
        function calculateTimelineProgress(timeline) {
            if (!timeline.sprints || !timeline.sprints.length) return 0;
            
            let totalProgress = 0;
            timeline.sprints.forEach(sprint => {
                totalProgress += calculateSprintProgress(sprint);
            });
            
            return Math.round(totalProgress / timeline.sprints.length);
        }
        
        function calculateSprintProgress(sprint) {
            if (!sprint.requirements || !sprint.requirements.length) return 0;
            
            let totalProgress = 0;
            sprint.requirements.forEach(req => {
                totalProgress += req.progress || 0;
            });
            
            return Math.round(totalProgress / sprint.requirements.length);
        }
        
        function calculateTaskProgress(task) {
            if (task.statusId === 4) return 100; // Completed
            if (task.statusId === 2) return 50;  // In Progress
            return 0; // Not Started
        }
        
        function calculateSubtaskProgress(subtask) {
            if (subtask.statusId === 4) return 100; // Completed
            if (subtask.statusId === 2) return 50;  // In Progress
            return 0; // Not Started
        }

        // Check if a task should be visible based on its parent's expanded state
        function isTaskVisible(taskId) {
            const task = flatTasks.find(t => t.id === taskId);
            if (!task) return false;
            
            // If task has no parent, it's always visible
            if (!task.parent) return true;
            
            // Check if all parents are expanded
            let parentId = task.parent;
            while (parentId) {
                const parent = flatTasks.find(t => t.id === parentId);
                if (!parent || !expandedState[parent.id]) {
                    return false;
                }
                parentId = parent.parent;
            }
            
            return true;
        }

        // Parse date string to Date object (handles both YYYY-MM-DD and other formats)
        function parseDate(dateString) {
            if (!dateString) return null;
            
            // Handle ISO format (YYYY-MM-DD)
            if (dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                const parts = dateString.split('-');
                return new Date(parts[0], parts[1] - 1, parts[2]);
            }
            
            // Fallback to native Date parsing
            return new Date(dateString);
        }

        // Calculate days between two dates
        function daysBetween(startDate, endDate) {
            const start = parseDate(startDate);
            const end = parseDate(endDate);
            
            if (!start || !end) return 0;
            
            // Calculate difference in days
            const diffTime = Math.abs(end - start);
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 to include both start and end days
        }

        // Calculate day offset from start date
        function dayOffsetFromStart(startDate, targetDate) {
            const start = parseDate(startDate);
            const target = parseDate(targetDate);
            
            if (!start || !target) return 0;
            
            // Calculate difference in days
            const diffTime = target - start;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Get month name in appropriate language
        function getMonthName(date, lang) {
            if (lang === 'ar') {
                const arabicMonths = ['يناير', 'فبراير', 'مارس', 'أبريل', 'مايو', 'يونيو', 
                                    'يوليو', 'أغسطس', 'سبتمبر', 'أكتوبر', 'نوفمبر', 'ديسمبر'];
                return arabicMonths[date.getMonth()];
            } else {
                return date.toLocaleString('en-US', { month: 'long' });
            }
        }

        // Render the Gantt chart
        function renderGanttChart() {
            if (!flatTasks || !flatTasks.length) return;
            
            const chartContainer = document.getElementById('gantt-chart');
            chartContainer.innerHTML = '';
            
            // Get the date range for the timeline
            const startDate = parseDate(timelineData.startDate);
            const endDate = parseDate(timelineData.endDate);
            
            if (!startDate || !endDate) {
                console.error('Invalid start or end date');
                return;
            }
            
            const daysDiff = daysBetween(timelineData.startDate, timelineData.endDate);
            
            // Create the grid
            const grid = document.createElement('div');
            grid.className = 'gantt-grid';
            
            // Set grid columns - fixed for task info and dynamic for days
            grid.style.gridTemplateColumns = `250px repeat(${daysDiff}, 30px)`;
            
            // Create header row with days
            // Task column header
            let headerTask = document.createElement('div');
            headerTask.className = 'grid-header';
            headerTask.textContent = language === 'ar' ? 'المهمة' : 'Task';
            headerTask.style.gridColumn = '1';
            grid.appendChild(headerTask);
            
            // Create month headers
            const monthSpans = {};
            let currentMonth = startDate.getMonth();
            let monthStartDay = 0;
            
            // Calculate month spans
            for (let i = 0; i < daysDiff; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);
                const month = currentDate.getMonth();
                
                if (month !== currentMonth) {
                    monthSpans[currentMonth] = i - monthStartDay;
                    currentMonth = month;
                    monthStartDay = i;
                }
                
                // Handle last day
                if (i === daysDiff - 1) {
                    monthSpans[month] = i - monthStartDay + 1;
                }
            }
            
            // Create month headers
            let dayCounter = 0;
            for (let month in monthSpans) {
                const monthSpan = monthSpans[month];
                if (monthSpan > 0) {
                    const monthHeader = document.createElement('div');
                    monthHeader.className = 'month-cell';
                    
                    const monthDate = new Date(startDate.getFullYear(), parseInt(month), 1);
                    monthHeader.textContent = getMonthName(monthDate, language);
                    
                    monthHeader.style.gridColumn = `${dayCounter + 2} / span ${monthSpan}`;
                    grid.appendChild(monthHeader);
                    
                    dayCounter += monthSpan;
                }
            }
            
            // Create day headers
            for (let i = 0; i < daysDiff; i++) {
                const currentDate = new Date(startDate);
                currentDate.setDate(startDate.getDate() + i);

                const dayHeader = document.createElement('div');
                dayHeader.className = 'grid-header day-cell';
                dayHeader.textContent = currentDate.getDate();
                dayHeader.title = currentDate.toLocaleDateString();
                dayHeader.style.gridColumn = i + 2;
                grid.appendChild(dayHeader);
            }
            
            // Create task rows
            flatTasks.forEach(task => {
                // Skip if task shouldn't be visible
                if (!isTaskVisible(task.id)) return;
                
                // Task info cell
                const taskInfo = document.createElement('div');
                taskInfo.className = 'grid-cell task-info';
                
                // Add expand/collapse toggle for tasks with children
                const hasChildren = flatTasks.some(t => t.parent === task.id);
                if (hasChildren) {
                    const toggle = document.createElement('span');
                    toggle.className = 'expand-toggle';
                    toggle.textContent = expandedState[task.id] ? '−' : '+';
                    toggle.onclick = (e) => {
                        e.stopPropagation();
                        expandedState[task.id] = !expandedState[task.id];
                        renderGanttChart();
                    };
                    taskInfo.appendChild(toggle);
                } else {
                    const spacer = document.createElement('span');
                    spacer.className = 'expand-toggle';
                    spacer.innerHTML = '&nbsp;';
                    taskInfo.appendChild(spacer);
                }
                
                // Add indentation and task title
                const titleSpan = document.createElement('span');
                titleSpan.innerHTML = `${'&nbsp;&nbsp;'.repeat(task.level)}${task.name}`;
                taskInfo.appendChild(titleSpan);
                
                taskInfo.style.gridColumn = '1';
                grid.appendChild(taskInfo);
                
                // Task bar container
                const taskBarContainer = document.createElement('div');
                taskBarContainer.className = 'grid-cell task-bar-container';
                taskBarContainer.style.gridColumn = `2 / ${daysDiff + 2}`;
                grid.appendChild(taskBarContainer);
                
                // Calculate position and width for task bar
                if (task.startDate && task.endDate) {
                    const taskStart = parseDate(task.startDate);
                    const taskEnd = parseDate(task.endDate);
                    
                    if (!taskStart || !taskEnd) {
                        console.error('Invalid task dates:', task.startDate, task.endDate);
                        return;
                    }
                    
                    const startDay = Math.max(0, dayOffsetFromStart(timelineData.startDate, task.startDate));
                    const endDay = Math.min(daysDiff - 1, dayOffsetFromStart(timelineData.startDate, task.endDate));
                    const duration = Math.max(1, endDay - startDay + 1);
                    
                    // Create task bar
                    const taskBar = document.createElement('div');
                    taskBar.className = 'task-bar';
                    
                    // Set color based on progress and type
                    if (task.progress === 100) {
                        taskBar.style.backgroundColor = '#4CAF50'; // Green for completed
                    } else if (task.progress > 0) {
                        taskBar.style.backgroundColor = '#2196F3'; // Blue for in progress
                    } else {
                        taskBar.style.backgroundColor = '#FF9800'; // Orange for not started
                    }
                    
                    // Different colors for different types
                    if (task.type === 'timeline') {
                        taskBar.style.backgroundColor = '#9C27B0'; // Purple for timeline
                    } else if (task.type === 'sprint') {
                        taskBar.style.backgroundColor = '#673AB7'; // Deep purple for sprint
                    } else if (task.type === 'requirement') {
                        taskBar.style.backgroundColor = '#3F51B5'; // Indigo for requirement
                    }
                    
                    // Position the task bar
                    const dayWidth = 30; // Fixed day width for consistent rendering
                    
                    // Fix for RTL layout - ensure proper positioning
                    if (language === 'ar') {
                        taskBar.style.right = `${startDay * dayWidth}px`;
                    } else {
                        taskBar.style.left = `${startDay * dayWidth}px`;
                    }
                    
                    taskBar.style.width = `${duration * dayWidth - 2}px`;
                    
                    // Add percentage text if there's enough space
                    if (duration * dayWidth > 40) {
                        taskBar.textContent = `${task.progress}%`;
                    }
                    
                    taskBarContainer.appendChild(taskBar);
                }
            });
            
            chartContainer.appendChild(grid);
            document.getElementById('loading').classList.add('hidden');
        }
    </script>
</body>
</html>